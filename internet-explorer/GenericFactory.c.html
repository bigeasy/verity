<!DOCTYPE html>
<html>
<head>
<title>GenericFactory.c</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="stylesheet" media="all" href="/verity/css/docco.css">
</head>
<body>
<div id="container">
<div id="background"></div>
  <table cellspacing="0" cellpadding="0">
    <thead>
      <tr>
        <th class="docs"><h1>GenericFactory.c</th>
        <th class="code"></th>
      </tr>
    </thead>
    <tbody>
      
        <tr>
          <td class="docs"><p>A boilerplate COM object factory.</p>

<p>The factory is a singleton. There is only ever one instance and it does not
get deallocated. Thus, the COM reference counting is a no-op. For an example
of COM reference in action, see the Verity controller object implementation.</p>

<p>The factory does maintain state. It maintains our library lock count.</p></td>
          <td class="code"><div class="highlight"><pre><div class="highlight"><pre></pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>System includes are in the precompiled header file. </p></td>
          <td class="code"><div class="highlight"><pre>
<span class="cp">#include &quot;stdafx.h&quot;</span>

</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>Local includes. </p></td>
          <td class="code"><div class="highlight"><pre>
<span class="cp">#include &quot;Log.h&quot;</span>
<span class="cp">#include &quot;GenericFactory.h&quot;</span>
<span class="cp">#include &quot;dllmain.h&quot;</span>
<span class="cp">#include &quot;ComponentObjectModel.h&quot;</span>

</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>Bogus lock count so we can use the COM macros used to define non-factory
objects. </p></td>
          <td class="code"><div class="highlight"><pre>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dwLockCount</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">GenericFactory</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">IClassFactoryVtbl</span> <span class="o">*</span><span class="n">lpVtbl</span><span class="p">;</span>
    <span class="n">GenericFactory_Constructor</span> <span class="n">constructor</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwCount</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="o">*</span><span class="n">pdwLockCount</span><span class="p">;</span>
<span class="p">}</span> <span class="n">GenericFactory</span><span class="p">;</span>

<span class="c1">// The object construction and server locking parts of the interface.</span>

</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>The IUnkown methods. Our singleton factory does not actually require an
reference counting, so we just ignore that. </p></td>
          <td class="code"><div class="highlight"><pre>

<span class="k">static</span> <span class="n">REFIID</span> <span class="n">ariidImplemented</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="o">&amp;</span><span class="n">IID_IUnknown</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">IID_IClassFactory</span><span class="p">,</span>
    <span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">QUERY_INTERFACE</span><span class="p">(</span><span class="n">IClassFactory</span><span class="p">,</span> <span class="n">ariidImplemented</span><span class="p">)</span>
<span class="n">REFERENCE_COUNT</span><span class="p">(</span><span class="n">IClassFactory</span><span class="p">,</span> <span class="n">GenericFactory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwLockCount</span><span class="p">,</span> <span class="n">NO_DESTRUCTOR</span><span class="p">);</span>

<span class="k">static</span> <span class="n">HRESULT</span> <span class="n">STDMETHODCALLTYPE</span>
<span class="nf">IClassFactory_CreateInstance</span><span class="p">(</span>
    <span class="n">IClassFactory</span> <span class="o">*</span><span class="n">pSelf</span><span class="p">,</span> <span class="n">IUnknown</span> <span class="o">*</span><span class="n">pOuter</span><span class="p">,</span> <span class="n">REFIID</span> <span class="n">guidVtbl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">ppv</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">HRESULT</span>              <span class="n">hr</span><span class="p">;</span>
    <span class="n">GenericFactory</span>     <span class="o">*</span><span class="n">pFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">GenericFactory</span><span class="o">*</span><span class="p">)</span> <span class="n">pSelf</span><span class="p">;</span>

</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>Assume the worst. </p></td>
          <td class="code"><div class="highlight"><pre>
    <span class="o">*</span><span class="n">ppv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>We never support aggregation. </p></td>
          <td class="code"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="n">pOuter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">CLASS_E_NOAGGREGATION</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">constructor</span><span class="p">(</span><span class="n">guidVtbl</span><span class="p">,</span> <span class="n">ppv</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">hr</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td>
        </tr>
      
        <tr>
          <td class="docs"><p>Increase or decrease the factory lock count. This prevents the ddl from
being unloaded. </p></td>
          <td class="code"><div class="highlight"><pre>
<span class="k">static</span> <span class="n">HRESULT</span> <span class="n">STDMETHODCALLTYPE</span>
<span class="nf">IClassFactory_LockServer</span><span class="p">(</span>
    <span class="n">IClassFactory</span> <span class="o">*</span><span class="n">pSelf</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">fLock</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">GenericFactory</span><span class="o">*</span> <span class="n">pFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">GenericFactory</span><span class="o">*</span><span class="p">)</span> <span class="n">pSelf</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fLock</span><span class="p">)</span> <span class="n">InterlockedIncrement</span><span class="p">(</span><span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">pdwLockCount</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">InterlockedDecrement</span><span class="p">(</span><span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">pdwLockCount</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">NOERROR</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// The factory virtual function table.</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">IClassFactoryVtbl</span> <span class="n">GenericFactoryVtbl</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">IClassFactory_QueryInterface</span><span class="p">,</span>
    <span class="n">IClassFactory_AddRef</span><span class="p">,</span>
    <span class="n">IClassFactory_Release</span><span class="p">,</span>
    <span class="n">IClassFactory_CreateInstance</span><span class="p">,</span>
    <span class="n">IClassFactory_LockServer</span>
<span class="p">};</span>

<span class="n">HRESULT</span>
<span class="nf">GenericFactory_CreateFactory</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">GUID</span> <span class="o">*</span> <span class="n">clsid</span><span class="p">,</span> <span class="n">GenericFactory_Constructor</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">GenericFactory_Finalizer</span> <span class="n">finalizer</span><span class="p">,</span>
    <span class="n">DWORD</span> <span class="o">**</span><span class="n">ppdwLockCount</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
    <span class="n">GenericFactory</span> <span class="o">*</span><span class="n">pFactory</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pFactory</span> <span class="o">=</span> <span class="n">GlobalAlloc</span><span class="p">(</span><span class="n">GMEM_FIXED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GenericFactory</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="n">dwLockCount</span><span class="o">++</span><span class="p">;</span>
        <span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">lpVtbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GenericFactoryVtbl</span><span class="p">;</span>
        <span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">constructor</span><span class="p">;</span>
        <span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">dwCount</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">pdwLockCount</span> <span class="o">=</span> <span class="n">RegisterObjectFactory</span><span class="p">(</span><span class="n">clsid</span><span class="p">,</span> <span class="p">(</span><span class="n">IClassFactory</span><span class="o">*</span><span class="p">)</span> <span class="n">pFactory</span><span class="p">,</span> <span class="n">finalizer</span><span class="p">);</span>
        <span class="o">*</span><span class="n">ppdwLockCount</span> <span class="o">=</span> <span class="n">pFactory</span><span class="o">-&gt;</span><span class="n">pdwLockCount</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">E_OUTOFMEMORY</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">GenericFactory_GenericFinalizer</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</pre></div></td>
        </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
